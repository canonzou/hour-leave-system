<script>
// 替换为你的阿里云函数地址
const API_URL = "https://hour-lee-system-fuugigjyme.cn-hangzhou.fcapp.run";

new Vue({
    el: '#app',
    data: {
        isLoggedIn: false,
        username: '',
        remainingHours: 0,
        activeTab: 'overtime',
        // 新增：用 Vue 数据控制加载状态，替代原生 DOM 操作
        isLoading: false,  

        // 加班表单数据
        overtimeStart: '',
        overtimeEnd: '',
        overtimeReason: '',
        // 补休表单数据
        leaveStart: '',
        leaveEnd: '',
        // 消息提示
        successMessage: '',
        errorMessage: '',
        loginError: ''
    },
    methods: {
        // 登录
        login() {
            if (!this.username.trim()) {
                this.loginError = "请输入姓名";
                return;
            }
            
            // 改用 Vue 数据控制加载
            this.isLoading = true; 
            this.loginError = '';
            
            fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    type: 'get',
                    username: this.username
                })
            })
            .then(response => response.json())
            .then(data => {
                // 加载状态重置
                this.isLoading = false; 
                if (data.success) {
                    this.remainingHours = data.remainingHours;
                    this.isLoggedIn = true;
                    this.successMessage = "登录成功";
                    setTimeout(() => this.successMessage = '', 3000);
                } else {
                    this.loginError = data.message || "登录失败，请重试";
                }
            })
            .catch(error => {
                this.isLoading = false; 
                this.loginError = "网络错误，请稍后重试";
                console.error('Error:', error);
            });
        },
        
        // 退出登录
        logout() {
            this.isLoggedIn = false;
            this.username = '';
            this.resetForm('all');
        },
        
        // 提交加班记录
        submitOvertime() {
            if (!this.validateOvertimeForm()) {
                return;
            }
            
            this.isLoading = true; 
            this.clearMessages();
            
            fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    type: 'overtime',
                    username: this.username,
                    startTime: this.formatDateTime(this.overtimeStart),
                    endTime: this.formatDateTime(this.overtimeEnd),
                    reason: this.overtimeReason
                })
            })
            .then(response => response.json())
            .then(data => {
                this.isLoading = false; 
                if (data.success) {
                    this.remainingHours = data.remainingHours;
                    this.successMessage = "加班记录提交成功";
                    this.resetForm('overtime');
                    setTimeout(() => this.successMessage = '', 3000);
                } else {
                    this.errorMessage = data.message || "提交失败，请重试";
                }
            })
            .catch(error => {
                this.isLoading = false; 
                this.errorMessage = "网络错误，请稍后重试";
                console.error('Error:', error);
            });
        },
        
        // 提交补休记录
        submitLeave() {
            if (!this.validateLeaveForm()) {
                return;
            }
            
            this.isLoading = true; 
            this.clearMessages();
            
            fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    type: 'leave',
                    username: this.username,
                    startTime: this.formatDateTime(this.leaveStart),
                    endTime: this.formatDateTime(this.leaveEnd)
                })
            })
            .then(response => response.json())
            .then(data => {
                this.isLoading = false; 
                if (data.success) {
                    this.remainingHours = data.remainingHours;
                    this.successMessage = "补休记录提交成功";
                    this.resetForm('leave');
                    setTimeout(() => this.successMessage = '', 3000);
                } else {
                    this.errorMessage = data.message || "提交失败，请重试";
                }
            })
            .catch(error => {
                this.isLoading = false; 
                this.errorMessage = "网络错误，请稍后重试";
                console.error('Error:', error);
            });
        },
        
        // 验证加班表单
        validateOvertimeForm() {
            if (!this.overtimeStart || !this.overtimeEnd) {
                this.errorMessage = "请填写完整的时间";
                return false;
            }
            
            if (!this.overtimeReason.trim()) {
                this.errorMessage = "请填写加班理由";
                return false;
            }
            
            if (new Date(this.overtimeStart) >= new Date(this.overtimeEnd)) {
                this.errorMessage = "结束时间必须晚于开始时间";
                return false;
            }
            
            // 计算时长（小时）
            const hours = (new Date(this.overtimeEnd) - new Date(this.overtimeStart)) / (1000 * 60 * 60);
            if (hours < 0.5) {
                this.errorMessage = "时长不能少于0.5小时";
                return false;
            }
            
            return true;
        },
        
        // 验证补休表单
        validateLeaveForm() {
            if (!this.leaveStart || !this.leaveEnd) {
                this.errorMessage = "请填写完整的时间";
                return false;
            }
            
            if (new Date(this.leaveStart) >= new Date(this.leaveEnd)) {
                this.errorMessage = "结束时间必须晚于开始时间";
                return false;
            }
            
            // 计算时长（小时）
            const hours = (new Date(this.leaveEnd) - new Date(this.leaveStart)) / (1000 * 60 * 60);
            if (hours < 0.5) {
                this.errorMessage = "时长不能少于0.5小时";
                return false;
            }
            
            // 检查是否超过剩余时长
            if (hours > this.remainingHours) {
                this.errorMessage = `补休时长不能超过剩余时长（${this.remainingHours}小时）`;
                return false;
            }
            
            return true;
        },
        
        // 重置表单
        resetForm(type) {
            this.clearMessages();
            if (type === 'overtime' || type === 'all') {
                this.overtimeStart = '';
                this.overtimeEnd = '';
                this.overtimeReason = '';
            }
            if (type === 'leave' || type === 'all') {
                this.leaveStart = '';
                this.leaveEnd = '';
            }
        },
        
        // 清除消息提示
        clearMessages() {
            this.successMessage = '';
            this.errorMessage = '';
        },
        
        // 格式化日期时间
        formatDateTime(datetime) {
            if (!datetime) return '';
            // 将YYYY-MM-DDThh:mm格式转换为YYYY-MM-DD HH:mm
            return datetime.replace('T', ' ');
        }
    }
});
</script>
