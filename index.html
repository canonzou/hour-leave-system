<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>小时假管理系统</title>
  <!-- 引入 Bootstrap 样式 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
  <!-- 引入 Vue 2 核心库 -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
  <!-- 引入 moment.js 处理时间 -->
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>

  <style>
    .container {
      max-width: 800px;
      margin-top: 30px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 10px;
    }
    .tab-content {
      margin-top: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .alert {
      margin-top: 15px;
      display: none;
    }
    /* 加载动画容器基础样式 */
    #loading {
      text-align: center;
      padding: 20px;
      display: none; /* 备用：若 Vue 响应式失效时的兜底 */
    }
  </style>
</head>
<body>
  <div class="container" id="app">
    <!-- 登录区域 -->
    <div v-if="!isLoggedIn">
      <h3 class="text-center mb-4">小时假管理系统</h3>
      <div class="form-group">
        <label for="username">请输入您的姓名：</label>
        <input type="text" class="form-control" id="username" v-model="username" placeholder="请输入姓名">
      </div>
      <button class="btn btn-primary" @click="login">登录</button>
      <div class="alert alert-danger" v-if="loginError">{{ loginError }}</div>
    </div>

    <!-- 主功能区域 -->
    <div v-if="isLoggedIn">
      <h3 class="text-center mb-4">欢迎回来，{{ username }}！</h3>
      <p class="text-center text-success">当前剩余可补休时长：{{ remainingHours }} 小时</p>

      <!-- 标签页 -->
      <ul class="nav nav-tabs">
        <li class="nav-item">
          <a class="nav-link" :class="{ active: activeTab === 'overtime' }" @click="activeTab = 'overtime'">加班记录</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" :class="{ active: activeTab === 'leave' }" @click="activeTab = 'leave'">补休记录</a>
        </li>
      </ul>

      <!-- 加载动画（Vue 响应式控制） -->
      <div id="loading" class="text-center" v-if="isLoading">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">处理中，请稍候...</p>
      </div>

      <!-- 加班表单 -->
      <div class="tab-content" v-if="activeTab === 'overtime'">
        <form @submit.prevent="submitOvertime">
          <div class="form-group">
            <label for="overtimeStart">加班开始时间：</label>
            <input type="datetime-local" class="form-control" id="overtimeStart" v-model="overtimeStart" required>
          </div>
          <div class="form-group">
            <label for="overtimeEnd">加班结束时间：</label>
            <input type="datetime-local" class="form-control" id="overtimeEnd" v-model="overtimeEnd" required>
          </div>
          <div class="form-group">
            <label for="overtimeReason">加班理由：</label>
            <textarea class="form-control" id="overtimeReason" v-model="overtimeReason" rows="3" required></textarea>
          </div>
          <button type="submit" class="btn btn-success">提交加班记录</button>
          <button type="button" class="btn btn-secondary ms-2" @click="resetForm('overtime')">重置</button>
        </form>
      </div>

      <!-- 补休表单 -->
      <div class="tab-content" v-if="activeTab === 'leave'">
        <form @submit.prevent="submitLeave">
          <div class="form-group">
            <label for="leaveStart">补休开始时间：</label>
            <input type="datetime-local" class="form-control" id="leaveStart" v-model="leaveStart" required>
          </div>
          <div class="form-group">
            <label for="leaveEnd">补休结束时间：</label>
            <input type="datetime-local" class="form-control" id="leaveEnd" v-model="leaveEnd" required>
          </div>
          <button type="submit" class="btn btn-success">提交补休记录</button>
          <button type="button" class="btn btn-secondary ms-2" @click="resetForm('leave')">重置</button>
        </form>
      </div>

      <!-- 消息提示 -->
      <div class="alert alert-success" v-if="successMessage">{{ successMessage }}</div>
      <div class="alert alert-danger" v-if="errorMessage">{{ errorMessage }}</div>

      <button class="btn btn-outline-primary mt-3" @click="logout">退出登录</button>
    </div>
  </div>

  <script>
    // 替换为你的阿里云函数实际地址
    const API_URL = "https://hour-lee-system-fuugigjyme.cn-hangzhou.fcapp.run";

    new Vue({
      el: '#app',
      data: {
        isLoggedIn: false,      // 登录状态标记
        username: '',          // 登录用户名
        remainingHours: 0,     // 剩余可补休时长
        activeTab: 'overtime', // 当前激活的标签页
        isLoading: false,      // 加载状态（替代原生 DOM 操作）
        
        // 加班表单数据
        overtimeStart: '',
        overtimeEnd: '',
        overtimeReason: '',
        // 补休表单数据
        leaveStart: '',
        leaveEnd: '',
        
        // 提示信息
        successMessage: '',
        errorMessage: '',
        loginError: ''
      },
      methods: {
        // 登录逻辑
        login() {
          if (!this.username.trim()) {
            this.loginError = "请输入姓名";
            return;
          }
          
          this.isLoading = true; // 显示加载动画
          this.loginError = '';  // 清空错误
            
          fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              type: 'get',
              username: this.username
            })
          })
          .then(res => res.json())
          .then(data => {
            this.isLoading = false; // 隐藏加载动画
            
            if (data.success) {
              this.remainingHours = data.remainingHours;
              this.isLoggedIn = true;
              this.successMessage = "登录成功";
              setTimeout(() => this.successMessage = '', 3000);
            } else {
              this.loginError = data.message || "登录失败，请重试";
            }
          })
          .catch(error => {
            this.isLoading = false;
            this.loginError = "网络错误，请稍后重试";
            console.error('登录请求失败:', error);
          });
        },

        // 退出登录
        logout() {
          this.isLoggedIn = false;
          this.username = '';
          this.resetForm('all');
        },

        // 提交加班记录
        submitOvertime() {
          if (!this.validateOvertimeForm()) return;
          
          this.isLoading = true;
          this.clearMessages();
            
          fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              type: 'overtime',
              username: this.username,
              startTime: this.formatDateTime(this.overtimeStart),
              endTime: this.formatDateTime(this.overtimeEnd),
              reason: this.overtimeReason
            })
          })
          .then(res => res.json())
          .then(data => {
            this.isLoading = false;
            
            if (data.success) {
              this.remainingHours = data.remainingHours;
              this.successMessage = "加班记录提交成功";
              this.resetForm('overtime');
              setTimeout(() => this.successMessage = '', 3000);
            } else {
              this.errorMessage = data.message || "提交失败，请重试";
            }
          })
          .catch(error => {
            this.isLoading = false;
            this.errorMessage = "网络错误，请稍后重试";
            console.error('加班提交失败:', error);
          });
        },

        // 提交补休记录
        submitLeave() {
          if (!this.validateLeaveForm()) return;
          
          this.isLoading = true;
          this.clearMessages();
            
          fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              type: 'leave',
              username: this.username,
              startTime: this.formatDateTime(this.leaveStart),
              endTime: this.formatDateTime(this.leaveEnd)
            })
          })
          .then(res => res.json())
          .then(data => {
            this.isLoading = false;
            
            if (data.success) {
              this.remainingHours = data.remainingHours;
              this.successMessage = "补休记录提交成功";
              this.resetForm('leave');
              setTimeout(() => this.successMessage = '', 3000);
            } else {
              this.errorMessage = data.message || "提交失败，请重试";
            }
          })
          .catch(error => {
            this.isLoading = false;
            this.errorMessage = "网络错误，请稍后重试";
            console.error('补休提交失败:', error);
          });
        },

        // 验证加班表单
        validateOvertimeForm() {
          if (!this.overtimeStart || !this.overtimeEnd) {
            this.errorMessage = "请填写完整的时间";
            return false;
          }
          if (!this.overtimeReason.trim()) {
            this.errorMessage = "请填写加班理由";
            return false;
          }
          if (new Date(this.overtimeStart) >= new Date(this.overtimeEnd)) {
            this.errorMessage = "结束时间必须晚于开始时间";
            return false;
          }
          const hours = (new Date(this.overtimeEnd) - new Date(this.overtimeStart)) / (1000 * 60 * 60);
          if (hours < 0.5) {
            this.errorMessage = "时长不能少于0.5小时";
            return false;
          }
          return true;
        },

        // 验证补休表单
        validateLeaveForm() {
          if (!this.leaveStart || !this.leaveEnd) {
            this.errorMessage = "请填写完整的时间";
            return false;
          }
          if (new Date(this.leaveStart) >= new Date(this.leaveEnd)) {
            this.errorMessage = "结束时间必须晚于开始时间";
            return false;
          }
          const hours = (new Date(this.leaveEnd) - new Date(this.leaveStart)) / (1000 * 60 * 60);
          if (hours < 0.5) {
            this.errorMessage = "时长不能少于0.5小时";
            return false;
          }
          if (hours > this.remainingHours) {
            this.errorMessage = `补休时长不能超过剩余时长（${this.remainingHours}小时）`;
            return false;
          }
          return true;
        },

        // 重置表单
        resetForm(type) {
          this.clearMessages();
          if (type === 'overtime' || type === 'all') {
            this.overtimeStart = '';
            this.overtimeEnd = '';
            this.overtimeReason = '';
          }
          if (type === 'leave' || type === 'all') {
            this.leaveStart = '';
            this.leaveEnd = '';
          }
        },

        // 清空提示信息
        clearMessages() {
          this.successMessage = '';
          this.errorMessage = '';
        },

        // 格式化时间（datetime-local 转字符串）
        formatDateTime(datetime) {
          return datetime ? datetime.replace('T', ' ') : '';
        }
      }
    });
  </script>
</body>
</html>
